<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="icon" href="assets/imgs/favicon.ico" type="image/x-icon">
    <title>Quartz Qr Scan</title>
    <section class="mt-6 space-y-6">
        <div data-owner-panel class="hidden"></div>
        <div data-mechanic-panel class="hidden"></div>
    </section>


    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase Core -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/app.css"/>
</head>

<body data-page="dashboard" class="min-h-screen">
<div id="site-header"></div>

<main class="max-w-6xl mx-auto px-4 py-10">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
            <h1 class="ty-headline">Dashboard</h1>
            <p class="ty-body-2 mt-2 text-slate-600">Points, QR History, And Promotions.</p>
        </div>
        <div class="flex gap-3">

            <a class="btn-ghost px-5 py-3 rounded-xl ty-subtitle-2" href="qr-list.html" data-auth-only>View QR List</a>
        </div>
    </div>

    <!-- Points Area (Owner: Shop + Mechanics | Mechanic: Personal Only) -->
    <section class="mt-6" data-points-area>
        <!-- JS Injected -->
    </section>

    <!-- Promotions Catalog (Visible To Everyone) -->
    <section class="mt-10">
        <div class="flex items-end justify-between gap-4">
            <div>
                <h2 class="ty-headline">Promotions Catalog</h2>
                <p class="ty-body-2 mt-2 text-slate-600">Visible To Everyone, Even If Not Signed In.</p>
            </div>
        </div>

        <!-- Owner Promotion Creator -->
        <div class="mt-6 card p-6" data-owner-only>
            <h3 class="ty-subtitle-1">Create A Promotion</h3>
            <p class="ty-caption mt-2 text-slate-500">Owner Only (Front Demo Uses LocalStorage).</p>

            <form class="mt-4 grid md:grid-cols-3 gap-4" data-promo-form>
                <div class="md:col-span-1">
                    <label class="ty-subtitle-2">Title</label>
                    <input name="title"
                           class="mt-2 w-full rounded-xl border border-slate-200 px-4 py-3 bg-white ty-body-2"
                           placeholder="New Quartz Deal">
                </div>

                <div class="md:col-span-1">
                    <label class="ty-subtitle-2">Image Url</label>
                    <input name="imageUrl"
                           class="mt-2 w-full rounded-xl border border-slate-200 px-4 py-3 bg-white ty-body-2"
                           placeholder="https://...">
                </div>

                <div class="md:col-span-3">
                    <label class="ty-subtitle-2">Description</label>
                    <textarea name="description" rows="3"
                              class="mt-2 w-full rounded-xl border border-slate-200 px-4 py-3 bg-white ty-body-2"
                              placeholder="Describe The Promotion..."></textarea>
                </div>

                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" class="btn-primary px-5 py-3 rounded-xl ty-subtitle-2">Publish Promotion
                    </button>
                </div>
            </form>
        </div>

        <div class="mt-6 grid md:grid-cols-3 gap-6" data-promotions-grid>
            <!-- JS Injected -->
        </div>
    </section>
</main>

<div id="site-footer"></div>
<script src="assets/supabase-client.js"></script>
<script src="assets/app-api.js"></script>
<script src="assets/include.js"></script>
<script>
    (async () => {
        const form = document.querySelector("[data-promo-form]");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const title = form.querySelector('[name="title"]').value.trim();
            const description = form.querySelector('[name="description"]').value.trim();
            const imageUrl = form.querySelector('[name="imageUrl"]').value.trim();

            if (!title || !description || !imageUrl) {
                alert("Please Fill In All Fields.");
                return;
            }

            try {
                await createPromotion({title, description, imageUrl});
                alert("Promotion Published.");
                form.reset();

                // Reload the catalog
                const promos = await listPublicPromotions();
                renderPromotionsInto("[data-promotions-grid]", promos);
            } catch (err) {
                alert(err.message || "Error Publishing Promotion.");
            }
        });
    })();
</script>
<script>
    (async () => {
        const profile = await getMyProfile();
        const ownerPanel = document.querySelector("[data-owner-panel]");
        const mechPanel = document.querySelector("[data-mechanic-panel]");

        if (!profile) return;

        if (profile.role === "Owner") {
            ownerPanel.classList.remove("hidden");

            const shop = await getShopTotal();
            const byMech = await getShopByMechanic();

            const rows = byMech.map(m => `
        <tr class="border-t border-slate-200">
          <td class="p-4 ty-body-2 font-medium">${m.mechanic_name}</td>
          <td class="p-4 ty-body-2 text-slate-600">${m.scans}</td>
          <td class="p-4 ty-body-2 text-slate-600">${m.points}</td>
        </tr>
      `).join("");

            ownerPanel.innerHTML = `
        <div class="grid md:grid-cols-3 gap-6">
          <div class="card p-6">
            <div class="ty-caption text-slate-500">Shop Total Points</div>
            <div class="ty-keyfigure mt-2">${shop?.shop_points ?? 0}</div>
          </div>
          <div class="card p-6">
            <div class="ty-caption text-slate-500">Shop Total Scans</div>
            <div class="ty-keyfigure mt-2">${shop?.shop_scans ?? 0}</div>
          </div>
          <div class="card p-6">
            <div class="ty-caption text-slate-500">Workshop</div>
            <div class="ty-subtitle-1 mt-2">${shop?.workshop_name ?? "â€”"}</div>
          </div>
        </div>

        <div class="card overflow-hidden">
          <div class="p-5 border-b border-slate-200">
            <div class="ty-subtitle-1">Points By Mechanic</div>
            <div class="ty-caption text-slate-500 mt-1">Detailed Breakdown Per Employee</div>
          </div>
          <div class="overflow-x-auto bg-white">
            <table class="min-w-full text-left">
              <thead class="bg-slate-50">
                <tr>
                  <th class="p-4 ty-caption text-slate-500">Mechanic</th>
                  <th class="p-4 ty-caption text-slate-500">Scans</th>
                  <th class="p-4 ty-caption text-slate-500">Points</th>
                </tr>
              </thead>
              <tbody>
                ${rows || ""}
              </tbody>
            </table>
          </div>
        </div>
      `;
        }

        if (profile.role === "Mechanic") {
            mechPanel.classList.remove("hidden");

            const mine = await getMyPoints();

            mechPanel.innerHTML = `
        <div class="grid md:grid-cols-2 gap-6">
          <div class="card p-6">
            <div class="ty-caption text-slate-500">My Points</div>
            <div class="ty-keyfigure mt-2">${mine?.my_points ?? 0}</div>
          </div>
          <div class="card p-6">
            <div class="ty-caption text-slate-500">My Scans</div>
            <div class="ty-keyfigure mt-2">${mine?.my_scans ?? 0}</div>
          </div>
        </div>

        <div class="card p-6">
          <div class="ty-subtitle-1">My Points Visibility</div>
          <p class="ty-body-2 mt-2 text-slate-600">
            You Can Only See The Points You Earned. Promotions Unlock Is Based On Shop Total Points.
          </p>
        </div>
      `;
        }
    })();
</script>

</body>
</html>
